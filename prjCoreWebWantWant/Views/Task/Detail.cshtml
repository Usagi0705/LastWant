@using System.Text.Json;
@*@model prjCoreWebWantWant.Models.CTaskWrap*@
@model prjCoreWebWantWant.Models.TaskList
@{
    ViewData["Title"] = "Detail";
    Layout = "~/Views/Shared/_Layout_Task.cshtml";
}

<head>
    <title> Map an Address</title>
    <script src="~/Scripts/jquery-1.6.4.min.js" type="text/javascript"> </script>
    <style>

        .image-container {
            display: inline-block;
        }

        .enlarge-on-hover {
            transition: transform 0.3s ease;
        }

            .enlarge-on-hover:hover {
                transform: scale(1.2);
            }


      <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous" />
        #map {
            height: 400px;
            width: 800px;
            margin: 5px auto;
            float: left; /* 將地圖元素靠左浮動 */
        }
    </style>
</head>


<main>

  
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="@Url.Content("~/Task/ListNew")">找工作</a></li>      
            @* <li class="breadcrumb-item active" aria-current="page">@Model.FTaskName</li>*@
            <li class="breadcrumb-item active" aria-current="page">@Model.TaskTitle</li>
        </ol>
    </nav>


    <div class="job-post-company pt-50 pb-120">
        <div class="container">           
            <div class="row justify-content-between">
               
               


                <div class="col-xl-7 col-lg-8">
                    <div class="job-tittle mb-50">
                        <div class="small-section-tittle">
                            <h4 style="display: flex; align-items: center;">
                                <img src="~/backstage1/img/task.png" alt="任務圖片" style="height: 30px; width: 30px; margin-right: 5px;">
                                任務名稱
                            </h4>
                        </div>
                        <p>@Model.TaskTitle</p>
                    </div>

                    <div class="job-post-details">
                        <div class="post-details1 mb-50">                     
                            <div class="small-section-tittle">                             
                                <h4 style="display: flex; align-items: center;">
                                    <img src="~/backstage1/img/meticulous.png" alt="任務圖片" style="height: 30px; width: 30px; margin-right: 5px;">
                                    任務詳細資料
                                </h4>
                            </div>
                            <p>@Model.TaskDetail</p>
                        </div>

                        <hr style="border: 1.5px  double ;  color:#528EAF" />

                        <div class="post-details2  mb-50">
                            <!-- Small Section Tittle -->
                            <div class="small-section-tittle">
                                <h4 style="display: flex; align-items: center;">
                                    <img src="~/backstage1/img/skills.png" alt="任務圖片" style="height: 25px; width: 25px; margin-right: 5px;">
                                    任務所需技能
                                </h4>
                            </div>
                            <ul>
                                @*失敗ㄉ一段QQname結尾的都是亂碼*@
                                @*<li>@Model.taskSkill</li>
                                <li>@Model.skill</li>      
                                <li>@Model.skillname.ToString()</li>       
                                <li>@Model.skillType</li>
                                <li>@Model.skilltypename.ToString()</li>*@
                            </ul>
                        </div>
                        <div class="post-details2  mb-50">
                            <!-- Small Section Tittle -->
                            <div class="small-section-tittle">                            
                                <h4 style="display: flex; align-items: center;">
                                    <img src="~/backstage1/img/pencil.png" alt="任務圖片" style="height: 23px; width: 23px; margin-right: 5px;">
                                    其他需求條件
                                </h4>
                            </div>
                            <ul>
                                @*<li></li>
                                <li></li>        *@                        
                            </ul>
                        </div>


                        @{
                            NewIspanProjectContext db = new NewIspanProjectContext();
                            var q = db.TaskPhotos.Where(t => t.CaseId == Model.CaseId).Select(t => t.PhotoPath).FirstOrDefault();
                        }
                        <hr style="border: 1.5px  double ;  color:#528EAF" />
                        @{
                            if (q != null)
                            {
                                <div class="post-details2  mb-50">
                                    <div class="small-section-tittle">
                                        <h4 style="display: flex; align-items: center;">
                                            <img src="~/backstage1/img/pictures.png" alt="任務圖片" style="height: 30px; width: 30px; margin-right: 5px;">
                                            任務相關照片
                                        </h4>
                                    </div>
                                    <div class="image-container">
                                        <img src="@Url.Content(q)" style="height:250px ; width:250px" alt="Image" class="enlarge-on-hover" />
                                 </div>
                            
                                
                           
                              @*  <img src="@Model.taskPhoto" class="img-thumbnail" alt="照片">*@
                              @* <img src="data:image/jpg;base64,@Convert.ToBase64String(@Model.taskPhoto.Photo)" alt="@Model.taskPhoto.Photo" width="200" height="150" />*@
                            @*    var base64Image = Convert.ToBase64String(Model.taskPhoto.Photo);
                                var imgSrc = $"data:image/png;base64,{base64Image}";
                                <img src="@imgSrc" class="img-thumbnail" alt="照片">*@
                               @*<img src="data:image/png;base64,@Convert.ToBase64String(Model.taskPhoto.Photo)" class="img-thumbnail" alt="沒有提供照片唷">*@
                                @*<img id="myself" src=@Url.Action("GetImage","Task")  class="img-fluid" style="height:85%; min-height:20%" alt="沒有提供照片唷">*@                            
                        </div>
                            }
                        }
                        <div class="post-details2  mb-50">                     
                            <div class="small-section-tittle">                               
                                <h4 style="display: flex; align-items: center;">
                                    <img src="~/backstage1/img/map.png" alt="任務圖片" style="height: 30px; width: 30px; margin-right: 5px;">
                                    任務地點
                                </h4>
                            </div>
                            <p>@Model.Address</p>
                            <div id="map" style="height:350px;width:600px;margin:5px auto;"></div>
                        </div>



                    </div>
                </div>
                

                <!-- 右邊資訊欄 -->
                <div class="col-xl-4 col-lg-4">
                    <div class="post-details3  mb-50" style="border: 1.5px double #528EAF;">
                        <div class="small-section-tittle">                        
                            <h4 style="display: flex; align-items: center;">
                                <img src="~/backstage1/img/information.png" alt="任務圖片" style="height: 30px; width: 30px; margin-right: 5px;">
                                任務資訊
                            </h4>
                        </div>
                        <ul>
                            <li>刊登日期：<span>@Model.PublishStart</span></li>
                            <li>任務地點：<span>@Model.Address</span></li>
                            <li>需求人數<span>@Model.RequiredNum</span></li>
                            <li>任務時段：<span>@Model.TaskStartHour ~ @Model.TaskEndHour</span></li>
                            <li>任務報酬：<span>@Model.PayFrom</span></li>
                            <li>刊登日期：<span>@Model.PublishStart</span></li>
                        </ul>
                        <div class="apply-btn2" style="display: flex; justify-content: center; align-items: center; width:200px; height:35px; border-radius: 50px;background-color:#528EAF;color:white">
                            @*<a href="#" class="btn">立即應徵</a>*@
                            @*  <a href="@Url.Action("Apply", new { id=Model.FId })" target="_blank">詳細資訊</a>*@
@*                            <a href="@Url.Action("Apply", new { id = Model.FId })" target="_blank" id="myInput">立即應徵</a>*@
                            <button data-bs-toggle="modal" data-bs-target="#myModal" id="btnApply" value="@Model.CaseId" class="btn btn-outliine-secondary" style="color:white">立即應徵</button>
                           

                          @*  <a href="#" id="applyButton" class="btn btn-outline-primary">立即應徵</a>*@


                            @*判斷登入*@
                          @*@inject Microsoft.AspNetCore.Http.IHttpContextAccessor HttpContextAccessor
                            @{
                                if (HttpContextAccessor.HttpContext.Session.Keys.Contains(CDictionary.SK_LOGINED_USER))
                                {
                                    <a href="#" data-bs-toggle="modal" data-bs-target="#myModal" id="applyNow">立即應徵</a>
                                }
                                else
                                {
                                    <a href="@Url.Content("~/Member/Login")" id="NoLogin">請登入以應徵</a>
                                }
                            }*@
                        </div>                     
                    </div>

                    @*應徵按鈕下方的公司資訊*@
                    <div class="post-details3  mb-50" style="border: 1.5px double #528EAF;">
                        <div class="small-section-tittle">                         
                            <h4 style="display: flex; align-items: center;">
                                <img src="~/backstage1/img/personal-information.png" alt="任務圖片" style="height: 30px; width: 30px; margin-right: 5px;">
                                刊登者資訊
                            </h4>
                        </div>                     
                        <p></p>
                        <ul>
                            <li>刊登案主：<span>@*@Model.AccountId*@ 林小姐</span></li>
                            <li>Email：<span>want@want.com</span></li>
                        @*    <li> <span>cc</span></li>*@
                        </ul>
                    </div>




                </div>
            </div>
        </div>
</div>
    @* @inject Microsoft.AspNetCore.Http.IHttpContextAccessor HttpContextAccessor
    @{
        if (!HttpContextAccessor.HttpContext.Session.Keys.Contains(CDictionary.SK_LOGINED_USER)) //判斷是否有登入
        {
            return;
        }

            string userDataJson = HttpContextAccessor.HttpContext.Session.GetString(CDictionary.SK_LOGINED_USER);
            CLoginUser loggedInUser = JsonSerializer.Deserialize<CLoginUser>(userDataJson); //loggedInUser的資料型態為MemberAccount這個資料表                                                                                   // 现在 loggedInUser 对象包含了从会话中取出的用户信息
            int id = loggedInUser.AccountId; //抓登入者的id


            NewIspanProjectContext db = new NewIspanProjectContext();
            var resumes = db.Resumes
            .Where(r => r.IsExpertOrNot == false && r.AccountId == id && r.CaseStatusId != 22).ToList();
    } *@
    @*未登入會出問題 待解決*@

    
   


    @*點選立即應徵之後的modal*@      
    <div class="modal" tabindex="-1" id="myModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">請選擇履歷</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">

                 @* @foreach (var item in resumes)
                 { *@
                    @*履歷一*@
                    <div class="col">
                            <div class="card h-100">                           
                            <div class="card-body" width="300px">
                                @* <h4 class="card-title text-center" style="color:#528EAF">@item.ResumeTitle</h4> *@
                                <hr />
                              
                              @*   @if (item.Autobiography.Length <= 70)
                                {
                                    <p class="card-text">@item.Autobiography</p>
                                }
                                else
                                {
                                    <p class="card-text">@item.Autobiography.Substring(0,70)... </p>  秀出自傳的部分內容
                                } *@
                                      <div class="card-footer text-center">
                                    <form action="@Url.Content("~/Backstage/apply")" method="post">
                                        <!-- 使用表單元素包裹 -->
                                        <input onclick="Alert()"
                                               class="btn btn-primary"
                                               style="background-color: #528EAF"
                                               type="submit"
                                               value="以此履歷應徵" />
                                        @* <input type="hidden" name="resumeId" value="@item.ResumeId"> *@
                                        <input type="hidden" id="selectedCaseId" name="caseId" />
                                    </form>
                                    </div>                                
                            </div>
                             </div>
                    </div>
                    <p></p>
                 @* } *@
                 
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消應徵</button>
                    @*<button type="button" class="btn btn-primary">立即應徵</button>*@
                </div>
            </div>
        </div>
    </div>
             
    }}
    </div>
      
 
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm" crossorigin="anonymous"></script>


</main>

@section Styles{
    <style>
    
        
    </style>
}


@section Scripts{
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> <!-- 引入 jQuery -->
    <script>

            const myModal = document.querySelector('#myModal');
            const myInput = document.querySelector('#myInput');

            myModal.addEventListener('show', function () {
            myModal.show();

           
        document.addEventListener("DOMContentLoaded", function () {
            var applyButton = document.getElementById("applyButton");
            applyButton.addEventListener("click", function (event) {
                event.preventDefault();

                $.ajax({
                    url: "/Task/IsUserLoggedIn",
                    type: "POST",
                    success: function (result) {
                        if (result) {
                            // 使用者已登入，顯示模態框
                            var myModal = new bootstrap.Modal(document.getElementById("myModal"));
                            myModal.show();
                        } else {
                            // 使用者未登入，導向登入頁面
                            window.location.href = "~/View/Member/Login"; // 替換為你的登入頁面 URL
                        }
                    }
                });
            });
        });
        })

        const googleMapsScript = document.createElement("script");
        googleMapsScript.src = "https://maps.googleapis.com/maps/api/js?key=AIzaSyCRStl7AgIq-q26mULwe9h-dMZX0uGSzKc&callback=initMap";
        document.head.appendChild(googleMapsScript);

        const isAddressEmpty = @Json.Serialize(ViewBag.IsAddressEmpty);
        const mapAddress = @Json.Serialize(ViewBag.MapAddress);

        function initMap() {
            map = new google.maps.Map(document.getElementById("map"), {              
                    center: isAddressEmpty ? { lat: 25.034280, lng: 121.543437 } : null,
                    zoom: isAddressEmpty ? 20 : 17,
            });

                if (!isAddressEmpty) {
                    const geocoder = new google.maps.Geocoder();
                    geocoder.geocode({ address: mapAddress }, (results, status) => {
                        if (status === google.maps.GeocoderStatus.OK) {
                            const latitude = results[0].geometry.location.lat();
                            const longitude = results[0].geometry.location.lng();
                            const Latlng = new google.maps.LatLng(latitude, longitude);

                            new google.maps.Marker({
                                position: Latlng,
                                map: map,
                            });

                            map.setCenter(Latlng);
                        } else {
                            console.error(status);
                        }
                    });
            } else {
                map.setCenter({ lat: 25.034280, lng: 121.543437 }); // 設定地圖中心位置為台北市大安區復興南路一段390號
            }
        }

        const selectedCaseId = document.querySelector('#selectedCaseId');
        const Apply = document.querySelector('#btnApply');
        Apply.addEventListener('click',() => {
            selectedCaseId.value = Apply.value;
            console.log(selectedCaseId.value);
        })
       
    </script>

    
}




                     